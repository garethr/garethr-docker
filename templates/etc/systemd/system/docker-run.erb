# This file is managed by Puppet and local changes
# may be overwritten

[Unit]
Description=Daemon for <%= @title %>
After=docker.service
<% if @after %>After=<%= @sanitised_after_array.map{ |a| "#{@service_prefix}#{a}.service"}.join(" ") %><% end %>
<% if @depends %>After=<%= @sanitised_depends_array.map{ |d| "#{@service_prefix}#{d}.service"}.join(" ") %><% end %>
Requires=docker.service
<% if @after %>Wants=<%= @sanitised_after_array.map{ |a| "#{@service_prefix}#{a}.service"}.join(" ") %><% end %>
<% if @depends %>Requires=<%= @sanitised_depends_array.map{ |d| "#{@service_prefix}#{d}.service"}.join(" ") %><% end %>

[Service]
Restart=on-failure
StartLimitInterval=20
StartLimitBurst=5
TimeoutStartSec=0
Environment="HOME=/root"
ExecStartPre=-/usr/bin/<%= @docker_command %> kill <%= @sanitised_title %>
ExecStartPre=-/usr/bin/<%= @docker_command %> rm <%= @sanitised_title %>
<% @extra_systemd_parameters.each do |key, value| -%><%= key %>=<%= value %>
<% end -%>
<%- if @pull_on_start %>ExecStartPre=-/usr/bin/<%= @docker_command %> pull <%= @image %>
<% end -%>
ExecStart=/usr/bin/<%= @docker_command %> run \
        <%= @docker_run_flags %> \
        --name <%= @sanitised_title %> \
        <%= @image %> \
        <% if @command %> <%= @command %><% end %>
<%- if @before_stop %>ExecStop=-<%= @before_stop %>
<% end -%>
ExecStop=-/usr/bin/<%= @docker_command %> stop <%= @sanitised_title %>

[Install]
WantedBy=multi-user.target
